name: Production v17 (Git & Protocol Fix)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  deploy-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 355
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. START NGROK
      - name: ğŸš‡ Start Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          ngrok http --domain=${{ secrets.NGROK_DOMAIN }} 80 > ngrok.log &
          sleep 5

      # 2. UPDATE NETLIFY
      - name: ğŸŒ Update Netlify
        run: |
          npm install -g netlify-cli
          rm -rf public && mkdir public
          echo '<h1>System Loading... (Wait 60s)</h1>' > public/index.html
          echo "/* https://${{ secrets.NGROK_DOMAIN }}/:splat 200!" > public/_redirects
          netlify deploy --prod --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_TOKEN }} --dir=public

      # 3. CREATE BOT FILES
      - name: ğŸ“ Create Bot Files
        run: |
          mkdir whatsapp
          # Basic Package JSON
          echo '{"name":"wa-bot","main":"index.js","scripts":{"start":"node index.js"},"dependencies":{"@whiskeysockets/baileys":"6.6.0","axios":"^1.6.0","express":"^4.18.2","mongoose":"^8.0.0","pino":"^8.16.1","qrcode":"^1.5.3","node-cache":"^5.1.2"}}' > whatsapp/package.json

          # Index JS
          cat << 'EOF' > whatsapp/index.js
          const { default: makeWASocket, useMultiFileAuthState, makeCacheableSignalKeyStore, DisconnectReason, BufferJSON } = require('@whiskeysockets/baileys');
          const express = require('express'); const axios = require('axios'); const mongoose = require('mongoose'); const QRCode = require('qrcode'); const pino = require('pino');
          const app = express(); app.use(express.json());
          const PORT = 10000; const MONGO_URL = process.env.MONGODB_URI; const N8N_URL = "http://n8n:5678/webhook/whatsapp"; 
          
          const connectDB = async () => { try { await mongoose.connect(MONGO_URL); console.log("âœ… Mongo Connected"); } catch (e) { console.error("âŒ Mongo Error:", e.message); setTimeout(connectDB, 5000); } }; connectDB();

          const authSchema=new mongoose.Schema({_id:String,data:Object});const AuthModel=mongoose.model('Auth',authSchema);
          async function useMongoDB(){const writeData=async(d,i)=>{try{await AuthModel.findOneAndUpdate({_id:i},{data:JSON.parse(JSON.stringify(d,BufferJSON.replacer)),_id:i},{upsert:!0})}catch(e){}};const readData=async(i)=>{try{const d=await AuthModel.findById(i);return d?JSON.parse(JSON.stringify(d.data,BufferJSON.reviver)):null}catch(e){return null}};const removeData=async(i)=>{try{await AuthModel.findByIdAndDelete(i)}catch(e){}};const creds=(await readData('creds'))||(await(require('@whiskeysockets/baileys').initAuthCreds)());return{state:{creds,keys:{get:async(t,i)=>{const d={};await Promise.all(i.map(async id=>{let v=await readData(`${t}-${id}`);if(t==='app-state-sync-key'&&v)v=require('@whiskeysockets/baileys/lib/Utils/auth-utils').proto.Message.AppStateSyncKeyData.fromObject(v);if(v)d[id]=v}));return d},set:async d=>{const t=[];for(const c in d)for(const i in d[c]){const v=d[c][i],k=`${c}-${i}`;t.push(v?writeData(v,k):removeData(k))}await Promise.all(t)}}},saveCreds:()=>writeData(creds,'creds'),clear:async()=>{await AuthModel.deleteMany({})}};}
          
          let sock; let qrData=null;
          async function startBot() {
             if(mongoose.connection.readyState === 0) { setTimeout(startBot, 3000); return; }
             const { state, saveCreds, clear } = await useMongoDB();
             sock = makeWASocket({ auth: { creds: state.creds, keys: makeCacheableSignalKeyStore(state.keys, pino({ level: "fatal" })) }, printQRInTerminal: false, logger: pino({ level: 'silent' }), browser: ["Shiksha Bot", "Chrome", "20.0.0"] });
             sock.ev.on('creds.update', saveCreds);
             sock.ev.on('connection.update', (u) => { const {connection, lastDisconnect, qr}=u; if(qr) qrData=qr; if(connection==='open') qrData=null; if(connection==='close'){ if(lastDisconnect.error?.output?.statusCode!==DisconnectReason.loggedOut) startBot(); } });
             sock.ev.on('messages.upsert', async({messages})=>{ const m=messages[0]; if(!m.message||m.key.fromMe)return; try{ await axios.post(N8N_URL, {from:(m.key.participant||m.key.remoteJid).split('@')[0], text:m.message.conversation||m.message.extendedTextMessage?.text, name:m.pushName}); }catch(e){} });
          }
          app.get('/qr', async(q,r)=>{ if(sock?.ws?.isOpen)return r.send('<h1>Connected</h1>'); if(!qrData)return r.send('<h1>Loading...</h1>'); r.send(`<img src="${await QRCode.toDataURL(qrData)}" />`); });
          app.listen(PORT, ()=> { console.log("Bot running"); startBot(); });
          EOF

      # 4. START SERVICES (Fixes Applied Here)
      - name: ğŸš€ Start Everything
        run: |
          docker network create bot-net

          # Caddy
          cat << 'EOF' > Caddyfile
          :80 {
            reverse_proxy /qr wa-bot:10000
            reverse_proxy /* n8n:5678
          }
          EOF
          docker run -d --name caddy --network bot-net -p 80:80 -v $(pwd)/Caddyfile:/etc/caddy/Caddyfile caddy

          # N8N FIX: Force 'postgres://' protocol
          # We take the secret, replace postgresql:// with postgres:// and pass it
          CLEAN_DB_URL=$(echo "${{ secrets.SUPABASE_URL }}" | sed 's/^postgresql:\/\//postgres:\/\//')

          docker run -d --name n8n --network bot-net \
            -e DB_TYPE=postgresdb \
            -e DB_POSTGRESDB_CONNECTION_STRING="$CLEAN_DB_URL" \
            -e N8N_ENCRYPTION_KEY="kuchbhi123" \
            -e N8N_SECURE_COOKIE=false \
            -e WEBHOOK_URL="https://shikshaportal.netlify.app/" \
            n8nio/n8n

          # BOT FIX: Install Git first!
          # We use 'apk add git' before 'npm install'
          docker run -d --name wa-bot --network bot-net \
            -v $(pwd)/whatsapp:/app -w /app \
            -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            node:20-alpine sh -c "apk add --no-cache git && npm install && node index.js"

      # 5. DIAGNOSIS
      - name: ğŸ©º Check Health
        run: |
          echo "Waiting 30s..."
          sleep 30
          echo "--- N8N LOGS ---"
          docker logs n8n 2>&1 | tail -n 20
          echo "--- BOT LOGS ---"
          docker logs wa-bot 2>&1 | tail -n 20

      # 6. KEEP ALIVE
      - name: â³ System Live
        run: |
          echo "âœ… URL: https://shikshaportal.netlify.app"
          sleep 21300
