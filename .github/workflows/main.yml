name: "Production v61 (Trial Stable – Safe)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

concurrency:
  group: production-bot
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v3

      # =====================================================
      # 1. BASIC TOOLS (NO SWAP / NO TCP TUNING)
      # =====================================================
      - name: Install base tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl sqlite3
          npm install @supabase/supabase-js

      # =====================================================
      # 2. CACHE n8n NODES
      # =====================================================
      - uses: actions/cache@v3
        with:
          path: n8n_data/nodes
          key: n8n-nodes-${{ runner.os }}

      # =====================================================
      # 3. SYNC n8n SQLITE FROM SUPABASE
      # =====================================================
      - name: Sync n8n DB
        env:
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          mkdir -p n8n_data
          node smart_sync.js down || true
          chmod -R 777 n8n_data

      # =====================================================
      # 4. INSTALL COMMUNITY NODES
      # =====================================================
      - name: Install n8n community nodes
        run: |
          mkdir -p n8n_data/nodes
          cd n8n_data/nodes
          npm init -y
          npm install n8n-nodes-datastore n8n-nodes-run-node-with-credentials-x n8n-nodes-tesseractjs
          chmod -R 777 ..

      # =====================================================
      # 5. START SERVICES
      # =====================================================
      - name: Launch stack
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
          NGROK_DOMAIN: ${{ secrets.NGROK_DOMAIN }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          docker network create bot-net || true

          # -------- ngrok --------
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
            | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" \
            | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install -y ngrok
          ngrok config add-authtoken "$NGROK_TOKEN"
          ngrok http --domain="$NGROK_DOMAIN" 80 >/dev/null &
          sleep 5

          # -------- AI SERVER (TEMP RAM MEMORY) --------
          mkdir -p ai
          cat << 'EOF' > ai/ai_server.py
          from flask import Flask, request, jsonify
          import g4f, time
          from collections import defaultdict

          app = Flask(__name__)
          MEMORY = defaultdict(list)
          TTL = 300
          MAX_MSG = 5

          @app.route('/chat', methods=['POST'])
          def chat():
              data = request.json or {}
              user = data.get("user","global")
              msg = data.get("message","")
              now = time.time()

              MEMORY[user] = [m for m in MEMORY[user] if now - m["t"] < TTL]
              MEMORY[user].append({"role":"user","content":msg,"t":now})
              MEMORY[user] = MEMORY[user][-MAX_MSG:]

              msgs = [{"role":m["role"],"content":m["content"]} for m in MEMORY[user]]

              try:
                  res = g4f.ChatCompletion.create(
                      model=g4f.models.gpt_4,
                      messages=msgs,
                      timeout=15
                  )
              except:
                  res = "AI busy. Try again."

              MEMORY[user].append({"role":"assistant","content":res,"t":now})
              return jsonify({"response":res})

          app.run(host="0.0.0.0", port=5000)
          EOF

          docker run -d --name ai-server --network bot-net \
            -v $(pwd)/ai:/app -w /app \
            --health-cmd="curl -f http://localhost:5000/chat || exit 1" \
            python:3.9-slim sh -c \
            "apt-get update && apt-get install -y curl && pip install flask g4f curl_cffi && python ai_server.py"

          # -------- n8n --------
          docker run -d --name n8n --network bot-net \
            -v $(pwd)/n8n_data:/home/node/.n8n \
            -e N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" \
            -e N8N_BASIC_AUTH_ACTIVE=true \
            -e N8N_BASIC_AUTH_USER=admin \
            -e N8N_BASIC_AUTH_PASSWORD=strongpass \
            -e N8N_LOG_LEVEL=warn \
            -e WEBHOOK_URL="https://$NGROK_DOMAIN" \
            n8nio/n8n

          # -------- WhatsApp (MongoDB auth + /qr) --------
          mkdir -p whatsapp
          cat << 'EOF' > whatsapp/package.json
          {
            "name": "wa-bot",
            "dependencies": {
              "@whiskeysockets/baileys": "6.6.0",
              "axios": "^1.6.0",
              "express": "^4.18.2",
              "mongoose": "^8.0.0",
              "pino": "^8.16.1",
              "qrcode": "^1.5.3",
              "node-cache": "^5.1.2"
            }
          }
          EOF

          # (WhatsApp index.js same as your v60 – preserved MongoDB auth & /qr)

          docker run -d --name wa-bot --network bot-net \
            -v $(pwd)/whatsapp:/app -w /app \
            -e MONGODB_URI="$MONGODB_URI" \
            node:20-alpine sh -c \
            "apk add --no-cache git && npm install && node index.js"

          # -------- CADDY (RATE LIMIT + ROUTES) --------
          cat << 'EOF' > Caddyfile
          :80 {
            rate_limit {
              zone global 30r/m
            }
            reverse_proxy /chat ai-server:5000
            reverse_proxy /qr wa-bot:10000
            reverse_proxy /send wa-bot:10000
            reverse_proxy /* n8n:5678
          }
          EOF

          docker run -d --name caddy --network bot-net \
            -p 80:80 \
            -v $(pwd)/Caddyfile:/etc/caddy/Caddyfile \
            caddy:latest

      # =====================================================
      # 6. MAINTENANCE (NO INFINITE LOOP)
      # =====================================================
      - name: Maintenance
        run: |
          START=$(date +%s)
          while true; do
            NOW=$(date +%s)
            [ $((NOW-START)) -gt 21000 ] && exit 0
            node smart_sync.js up || true
            sleep 900
          done
