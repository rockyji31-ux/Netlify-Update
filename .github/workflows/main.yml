name: Project Flash v22 (Supabase Hybrid)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  run-hybrid-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 355
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --------------------------------------------------------
      # 1. SETUP ENVIRONMENT & NGROK
      # --------------------------------------------------------
      - name: üöá Start Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          ngrok http --domain=${{ secrets.NGROK_DOMAIN }} 80 > ngrok.log &
          
      - name: üåê Update Netlify
        run: |
          npm install -g netlify-cli
          rm -rf public && mkdir public
          echo '<h1>üöÄ Hybrid Mode Active</h1>' > public/index.html
          echo "/* https://${{ secrets.NGROK_DOMAIN }}/:splat 200!" > public/_redirects
          netlify deploy --prod --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_TOKEN }} --dir=public

      # --------------------------------------------------------
      # 2. THE MAGIC SCRIPT (Sync Logic)
      # --------------------------------------------------------
      - name: üîÆ Create Sync Script
        run: |
          # Install Supabase Client
          npm install @supabase/supabase-js

          # Create the Sync Manager
          cat << 'EOF' > sync.js
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs');
          const path = 'n8n_data/database.sqlite';
          
          const supabase = createClient(
            process.env.SUPABASE_URL, 
            process.env.SUPABASE_KEY
          );

          async function download() {
            console.log("üì• Downloading Database from Supabase...");
            const { data, error } = await supabase.storage.from('bot-storage').download('database.sqlite');
            if (error) {
              console.log("‚ö†Ô∏è No backup found (Fresh Start):", error.message);
            } else {
              const buffer = Buffer.from(await data.arrayBuffer());
              if (!fs.existsSync('n8n_data')) fs.mkdirSync('n8n_data');
              fs.writeFileSync(path, buffer);
              console.log("‚úÖ Database Restored!");
            }
          }

          async function upload() {
            console.log("üì§ Uploading Database to Supabase...");
            if (!fs.existsSync(path)) { console.log("‚ùå No DB to save"); return; }
            const fileContent = fs.readFileSync(path);
            const { error } = await supabase.storage.from('bot-storage').upload('database.sqlite', fileContent, { upsert: true });
            if (error) console.error("‚ùå Upload Failed:", error.message);
            else console.log("‚úÖ Backup Saved!");
          }

          const mode = process.argv[2];
          if (mode === 'down') download();
          if (mode === 'up') upload();
          EOF

      # --------------------------------------------------------
      # 3. RESTORE DATA (Pull)
      # --------------------------------------------------------
      - name: üì• Restore Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE }} # Secret Role Key is vital
        run: |
          mkdir -p n8n_data
          chmod 777 n8n_data
          node sync.js down

      # --------------------------------------------------------
      # 4. CREATE BOT & START SERVICES
      # --------------------------------------------------------
      - name: üöÄ Start Engine
        run: |
          mkdir whatsapp
          echo '{"name":"wa-bot","dependencies":{"@whiskeysockets/baileys":"6.6.0","axios":"^1.6.0","express":"^4.18.2","mongoose":"^8.0.0","pino":"^8.16.1","qrcode":"^1.5.3","node-cache":"^5.1.2"}}' > whatsapp/package.json
          
          # Bot Code
          cat << 'EOF' > whatsapp/index.js
          const { default: makeWASocket, useMultiFileAuthState, makeCacheableSignalKeyStore, DisconnectReason } = require('@whiskeysockets/baileys');
          const express = require('express'); const axios = require('axios'); const mongoose = require('mongoose'); const QRCode = require('qrcode'); const pino = require('pino');
          const app = express(); app.use(express.json());
          const PORT = 10000; const MONGO_URL = process.env.MONGODB_URI; const N8N_URL = "http://n8n:5678/webhook/whatsapp"; 
          const connectDB = async () => { try { await mongoose.connect(MONGO_URL); console.log("‚úÖ Mongo Connected"); } catch (e) { setTimeout(connectDB, 5000); } }; connectDB();
          const authSchema=new mongoose.Schema({_id:String,data:Object});const AuthModel=mongoose.model('Auth',authSchema);
          async function useMongoDB(){const writeData=async(d,i)=>{try{await AuthModel.findOneAndUpdate({_id:i},{data:d,_id:i},{upsert:!0})}catch(e){}};const readData=async(i)=>{try{const d=await AuthModel.findById(i);return d?d.data:null}catch(e){return null}};const removeData=async(i)=>{try{await AuthModel.findByIdAndDelete(i)}catch(e){}};const creds=(await readData('creds'))||(await(require('@whiskeysockets/baileys').initAuthCreds)());return{state:{creds,keys:{get:async(t,i)=>{const d={};await Promise.all(i.map(async id=>{let v=await readData(`${t}-${id}`);if(t==='app-state-sync-key'&&v)v=require('@whiskeysockets/baileys/lib/Utils/auth-utils').proto.Message.AppStateSyncKeyData.fromObject(v);if(v)d[id]=v}));return d},set:async d=>{const t=[];for(const c in d)for(const i in d[c]){const v=d[c][i],k=`${c}-${i}`;t.push(v?writeData(v,k):removeData(k))}await Promise.all(t)}}},saveCreds:()=>writeData(creds,'creds'),clear:async()=>{await AuthModel.deleteMany({})}};}
          let sock; let qrData=null;
          async function startBot() {
             if(mongoose.connection.readyState === 0) { setTimeout(startBot, 3000); return; }
             const { state, saveCreds } = await useMongoDB();
             sock = makeWASocket({ auth: { creds: state.creds, keys: makeCacheableSignalKeyStore(state.keys, pino({ level: "fatal" })) }, printQRInTerminal: false, logger: pino({ level: 'silent' }), browser: ["Shiksha Bot", "Chrome", "20.0.0"] });
             sock.ev.on('creds.update', saveCreds);
             sock.ev.on('connection.update', (u) => { const {connection, lastDisconnect, qr}=u; if(qr) qrData=qr; if(connection==='open') qrData=null; if(connection==='close'){ if(lastDisconnect.error?.output?.statusCode!==DisconnectReason.loggedOut) startBot(); } });
             sock.ev.on('messages.upsert', async({messages})=>{ const m=messages[0]; if(!m.message||m.key.fromMe)return; try{ await axios.post(N8N_URL, {from:(m.key.participant||m.key.remoteJid).split('@')[0], text:m.message.conversation||m.message.extendedTextMessage?.text, name:m.pushName}); }catch(e){} });
          }
          app.post('/send', async (req, res) => { try { if(!sock) return res.status(503).json({error:"Bot starting"}); const jid = req.body.number.includes('@') ? req.body.number : req.body.number + "@s.whatsapp.net"; await sock.sendMessage(jid, { text: req.body.message }); res.json({ status: true }); } catch (e) { res.status(500).json({ error: e.message }); } });
          app.get('/qr', async(q,r)=>{ if(sock?.ws?.isOpen)return r.send('<h1>Connected</h1>'); if(!qrData)return r.send('<h1>Loading...</h1>'); r.send(`<img src="${await QRCode.toDataURL(qrData)}" />`); });
          app.listen(PORT, ()=> { console.log("Bot running"); startBot(); });
          EOF

          docker network create bot-net
          
          cat << 'EOF' > Caddyfile
          :80 {
            reverse_proxy /qr wa-bot:10000
            reverse_proxy /* n8n:5678
          }
          EOF
          docker run -d --name caddy --network bot-net -p 80:80 -v $(pwd)/Caddyfile:/etc/caddy/Caddyfile caddy

          # n8n (Running on Local SQLite Volume)
          docker run -d --name n8n --network bot-net \
            -v $(pwd)/n8n_data:/home/node/.n8n \
            -e N8N_ENCRYPTION_KEY="kuchbhi123" \
            -e N8N_SECURE_COOKIE=false \
            -e WEBHOOK_URL="https://shikshaportal.netlify.app/" \
            n8nio/n8n

          # WhatsApp Bot
          docker run -d --name wa-bot --network bot-net \
            -v $(pwd)/whatsapp:/app -w /app \
            -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            node:20-alpine sh -c "apk add --no-cache git && npm install && (node index.js || sleep 3600)"

      # --------------------------------------------------------
      # 5. AUTO-BACKUP LOOP (Push every 15 mins)
      # --------------------------------------------------------
      - name: üíæ Sync Loop
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          echo "‚úÖ System Live. Starting Sync Engine..."
          
          # Run for ~5.5 Hours
          for i in {1..20}
          do
             sleep 900 # Wait 15 Minutes
             echo "üîÑ Auto-Syncing to Supabase..."
             node sync.js up
          done
          
          # Final Wait
          sleep 600
