# ==================================================================
      # 3. SMART DATA SYNC (Strict Mode)
      # ==================================================================
      - name: üíæ Setup Data Layer
        env:
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          N8N_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
        run: |
          mkdir -p n8n_data/nodes whatsapp public ai
          
          cat << 'EOF' > smart_sync.js
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs'); const { execSync, spawnSync } = require('child_process');
          
          const sbUrl = process.env.SUPABASE_URL;
          if (!sbUrl || !sbUrl.startsWith('http')) {
              console.error("‚ùå CRITICAL ERROR: 'SUPABASE_URL' Missing.");
              process.exit(1);
          }

          const sb = createClient(sbUrl, process.env.SUPABASE_KEY);
          const live='n8n_data/database.sqlite', safe='n8n_data/db_snap.sqlite';

          async function retry(fn, retries=3) {
            for (let i=0; i<retries; i++) {
              try { await fn(); return; } catch (err) {
                if (i === retries-1) throw err;
                await new Promise(r => setTimeout(r, 2000));
              }
            }
          }

          async function run(mode) {
            try {
              if(mode==='down') {
                console.log("üì• Downloading Backup...");
                await retry(async () => {
                   const { data, error } = await sb.storage.from('bot-storage').download('database.sqlite');
                   if(error) { console.log("‚ö†Ô∏è Fresh Start (No Backup Found)"); return; }
                   fs.writeFileSync(live, Buffer.from(await data.arrayBuffer()));
                   try { execSync("sqlite3 " + live + " 'PRAGMA journal_mode=WAL;'"); } catch(e) {}
                });
              } else {
                if(!fs.existsSync(live)) return;
                if(fs.existsSync(safe)) fs.unlinkSync(safe);
                execSync("sqlite3 " + live + " \".backup '" + safe + "'\"");
                execSync("sqlite3 " + safe + " 'VACUUM;'");
                
                console.log("üì§ Uploading Backup...");
                await retry(async () => {
                   const { error } = await sb.storage.from('bot-storage').upload('database.sqlite', fs.readFileSync(safe), { upsert: true });
                   if(error) throw error;
                });

                if (process.env.TG_TOKEN && process.env.TG_ID) {
                    try {
                        // --- ‚è∞ TIME & KEY FORMATTING FIX ---
                        const d = new Date();
                        const dateStr = d.toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata', day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
                        const timeStr = d.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' }).toUpperCase();
                        
                        // Adding the Key from Environment Variable
                        const n8nKey = process.env.N8N_KEY || 'Not Set';
                        const caption = `üíæ <b>Backup Success</b>\nüìÖ ${dateStr} ${timeStr}\nüîë Key: <code>${n8nKey}</code>`;
                        // ------------------------------------

                        const args = ["-s", "-F", `chat_id=${process.env.TG_ID}`, "-F", `document=@${safe};filename=n8n_backup.sqlite`, "-F", `caption=${caption}`, "-F", "parse_mode=HTML", `https://api.telegram.org/bot${process.env.TG_TOKEN}/sendDocument`];
                        spawnSync("curl", args);
                    } catch (e) {}
                }
              }
            } catch(e) { console.error("Sync Error:", e.message); }
          }
          run(process.argv[2]);
          EOF
          
          node smart_sync.js down
          sudo chmod -R 777 n8n_data
