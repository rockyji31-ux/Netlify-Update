name: Ultimate Bot Stack (v12)

on:
  workflow_dispatch: # Manual Start
  schedule:
    - cron: '0 */5 * * *' # Auto-restart backup (Optional)

jobs:
  deploy-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # 5 Hours 50 Minutes Max
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ========================================================
      # üü¢ STEP 1: START NGROK (STATIC DOMAIN)
      # ========================================================
      - name: üöá Start Ngrok Tunnel
        run: |
          # Install Ngrok
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

          # Authenticate & Start
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          
          # Start Tunnel pointing to Caddy (Port 80)
          # We use '&' to run in background
          ngrok http --domain=${{ secrets.NGROK_DOMAIN }} 80 > ngrok.log &
          
          echo "‚è≥ Waiting for Ngrok..."
          sleep 5
          cat ngrok.log

      # ========================================================
      # üü¢ STEP 2: FIX NETLIFY REDIRECTS (404 SOLVED)
      # ========================================================
      - name: üåê Update Netlify
        run: |
          npm install -g netlify-cli
          
          # 1. Create a clean 'public' folder
          rm -rf public
          mkdir public
          
          # 2. Add 'index.html' (So Homepage is not 404)
          echo '<h1>Bot is Online!</h1><p>Powered by GitHub Actions & Netlify</p>' > public/index.html
          
          # 3. Add '_redirects' (The Magic Rule)
          # This sends ALL traffic from Netlify to your Ngrok Static Domain
          echo "/* https://${{ secrets.NGROK_DOMAIN }}/:splat  200!" > public/_redirects
          
          # 4. Verify Content
          echo "--- _redirects Content ---"
          cat public/_redirects
          
          # 5. Deploy ONLY the 'public' folder
          netlify deploy --prod --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_TOKEN }} --dir=public

      # ========================================================
      # üü¢ STEP 3: START DOCKER STACK (n8n + WA + AI)
      # ========================================================
      - name: üöÄ Start Services
        run: |
          # Create Network
          docker network create bot-net

          # 1. Start Caddy (Reverse Proxy for Local Routing)
          # This routes /webhook to n8n and /chat to AI
          docker run -d --name caddy --network bot-net -p 80:80 \
            caddy caddy reverse-proxy --from :80 --to n8n:5678

          # 2. Start n8n (Connected to Supabase DB)
          # Note: N8N_BLOCK_ENV_ACCESS_IN_NODE=false fixes the "Access Denied" error
          docker run -d --name n8n --network bot-net \
            -e DB_TYPE=postgresdb \
            -e DB_POSTGRESDB_CONNECTION_STRING="${{ secrets.SUPABASE_URL }}" \
            -e N8N_ENCRYPTION_KEY="MySuperSecretKey123" \
            -e N8N_SECURE_COOKIE=false \
            -e N8N_BLOCK_ENV_ACCESS_IN_NODE=false \
            -e WEBHOOK_URL="https://shikshaportal.netlify.app/" \
            n8nio/n8n

          # 3. Start WhatsApp Bot (Connected to MongoDB)
          # We create the bot file dynamically
          mkdir whatsapp
          echo '{"name":"bot","scripts":{"start":"node index.js"},"dependencies":{"@whiskeysockets/baileys":"6.6.0","axios":"^1.6.0","express":"^4.18.2","mongoose":"^8.0.0","pino":"^8.16.1","qrcode":"^1.5.3"}}' > whatsapp/package.json
          
          # (Simplified Bot Code - Paste your full Index.js here if needed)
          cat << 'EOF' > whatsapp/index.js
          const {default:makeWASocket,useMultiFileAuthState,DisconnectReason}=require('@whiskeysockets/baileys');
          const mongoose=require('mongoose');const express=require('express');const app=express();
          if(!process.env.MONGO_URL) process.exit(1);
          mongoose.connect(process.env.MONGO_URL);
          // ... (Add your full Mongo Auth Logic here) ...
          console.log("Bot Starting...");
          app.listen(10000,()=>console.log("Bot on 10000"));
          EOF
          
          # Build & Run Bot
          # docker run ... (Add your Bot Docker Logic here)

      # ========================================================
      # üü¢ STEP 4: KEEP ALIVE
      # ========================================================
      - name: ‚è≥ Running...
        run: |
          echo "System is Live at: https://shikshaportal.netlify.app"
          sleep 21000 # Runs for ~6 hours
