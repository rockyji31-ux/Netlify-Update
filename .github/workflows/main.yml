name: Production v61 (Supervisor Safe Mode)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: production-bot
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y curl sqlite3 docker.io
        curl -fsSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install -y ngrok
        npm install @supabase/supabase-js

    # Restore n8n DB
    - name: Restore n8n
      env:
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      run: |
        mkdir -p n8n_data
        node <<'EOF'
        const {createClient}=require('@supabase/supabase-js')
        const fs=require('fs')
        const sb=createClient('https://ymatdzammnejrmmiyygg.supabase.co',process.env.SUPABASE_SERVICE_ROLE)
        sb.storage.from('bot-storage').download('database.sqlite').then(r=>{
          if(!r.error) fs.writeFileSync('n8n_data/database.sqlite',Buffer.from(r.data.arrayBuffer()))
        })
        EOF

    - name: Start services
      env:
        NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        NGROK_DOMAIN: ${{ secrets.NGROK_DOMAIN }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
      run: |
        docker network create bot-net

        # AI
        docker run -d --name ai-server --network bot-net python:3.9-slim sh -c "
        pip install flask g4f curl_cffi &&
        python - <<'EOF'
        from flask import Flask,request,jsonify
        import g4f
        app=Flask(__name__)
        @app.route('/chat',methods=['POST'])
        def c():
          m=request.json.get('message')
          r=g4f.ChatCompletion.create(model=g4f.models.gpt_4,messages=[{'role':'user','content':m}])
          return jsonify({'response':r})
        app.run('0.0.0.0',5000)
        EOF"

        # n8n
        docker run -d --name n8n --network bot-net \
        -v $(pwd)/n8n_data:/home/node/.n8n \
        -e N8N_ENCRYPTION_KEY=$N8N_ENCRYPTION_KEY \
        -e WEBHOOK_URL=https://$NGROK_DOMAIN \
        n8nio/n8n

        # WhatsApp
        docker run -d --name wa --network bot-net \
        -e MONGODB_URI=$MONGODB_URI \
        ghcr.io/whiskeysockets/baileys

        # Proxy
        docker run -d --name caddy --network bot-net -p 80:80 caddy

        ngrok config add-authtoken $NGROK_TOKEN
        ngrok http --domain=$NGROK_DOMAIN 80 &

    - name: Run 5h55m then handoff
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      run: |
        sleep 21300
        node smart_sync.js up || true
        gh workflow run main.yml
