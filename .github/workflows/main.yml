name: "Production v60 (Final Stable: AI Curl Fix)"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: "production-bot"
  cancel-in-progress: true

jobs:
  run-v60-final:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3

    # =========================================================
    # 1. SYSTEM + NGROK (UBUNTU 24 SAFE)
    # =========================================================
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl sqlite3 docker.io
        sudo systemctl start docker

        # Install ngrok (NO APT REPO â€” Ubuntu 24 safe)
        curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
        tar -xzf ngrok.tgz
        sudo mv ngrok /usr/local/bin/ngrok
        sudo chmod +x /usr/local/bin/ngrok

        npm install @supabase/supabase-js

    # =========================================================
    # 2. RESTORE N8N FROM SUPABASE
    # =========================================================
    - name: Restore n8n
      env:
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      run: |
        mkdir -p n8n_data
        node <<'EOF'
        const {createClient}=require('@supabase/supabase-js')
        const fs=require('fs')
        const sb=createClient('https://ymatdzammnejrmmiyygg.supabase.co',process.env.SUPABASE_SERVICE_ROLE)
        sb.storage.from('bot-storage').download('database.sqlite').then(r=>{
          if(!r.error) fs.writeFileSync('n8n_data/database.sqlite',Buffer.from(r.data.arrayBuffer()))
        })
        EOF

    # =========================================================
    # 3. START STACK (SAFE ORDER)
    # =========================================================
    - name: Start stack
      env:
        NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        NGROK_DOMAIN: ${{ secrets.NGROK_DOMAIN }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
      run: |
        docker network create bot-net || true

        # ---- AI SERVER ----
        docker run -d --name ai-server --network bot-net python:3.9-slim sh -c "
        pip install flask g4f curl_cffi &&
        python - <<'EOF'
        from flask import Flask,request,jsonify
        import g4f
        app=Flask(__name__)
        @app.route('/health')
        def h(): return 'ok'
        @app.route('/chat',methods=['POST'])
        def c():
          m=request.json.get('message')
          r=g4f.ChatCompletion.create(model=g4f.models.gpt_4,messages=[{'role':'user','content':m}])
          return jsonify({'response':r})
        app.run('0.0.0.0',5000)
        EOF"

        until docker exec ai-server curl -s http://localhost:5000/health; do sleep 5; done

        # ---- N8N ----
        docker run -d --name n8n --network bot-net \
        -v $(pwd)/n8n_data:/home/node/.n8n \
        -e N8N_ENCRYPTION_KEY=$N8N_ENCRYPTION_KEY \
        -e WEBHOOK_URL=https://$NGROK_DOMAIN \
        n8nio/n8n

        # ---- WHATSAPP ----
        docker run -d --name wa-bot --network bot-net \
        -e MONGODB_URI=$MONGODB_URI \
        ghcr.io/whiskeysockets/baileys

        # ---- CADDY ----
        docker run -d --name caddy --network bot-net -p 80:80 caddy

        # Wait until port 80 is live (prevents ERR_NGROK_8012)
        until curl -s http://localhost:80 >/dev/null; do sleep 3; done

        # ---- NGROK ----
        ngrok config add-authtoken $NGROK_TOKEN
        ngrok http --domain=$NGROK_DOMAIN 80 > /dev/null &

    # =========================================================
    # 4. 6-HOUR SUPERVISOR + HANDOFF
    # =========================================================
    - name: Supervisor
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      run: |
        START=$(date +%s)

        for i in {1..120}; do
          sleep 180

          # restart crashed containers
          for c in ai-server n8n wa-bot caddy; do
            if ! docker ps | grep -q $c; then docker restart $c; fi
          done

          # handoff at 5h55m
          NOW=$(date +%s)
          if [ $((NOW - START)) -gt 21300 ]; then
            gh workflow run main.yml
            sleep 600
            exit 0
          fi
        done
