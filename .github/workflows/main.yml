name: Test Step 1 (Direct Bot)

on: workflow_dispatch

jobs:
  test-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. Start Ngrok (Point to Port 10000 - Direct to Bot)
      - name: üöá Start Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          # Note: We are pointing to 10000 directly
          ngrok http --domain=${{ secrets.NGROK_DOMAIN }} 10000 > ngrok.log &
          sleep 5

      # 2. Update Netlify
      - name: üåê Update Netlify
        run: |
          npm install -g netlify-cli
          rm -rf public && mkdir public
          echo '<h1>Testing Mode</h1>' > public/index.html
          echo "/* https://${{ secrets.NGROK_DOMAIN }}/:splat 200!" > public/_redirects
          netlify deploy --prod --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_TOKEN }} --dir=public

      # 3. Create & Start Bot Only (No Docker, No Caddy)
      - name: ü§ñ Start Bot (Native)
        run: |
          mkdir bot
          cd bot
          npm init -y
          npm install express qrcode
          
          # Simple Test Server
          cat << 'EOF' > index.js
          const express = require('express');
          const QRCode = require('qrcode');
          const app = express();
          
          app.get('/', (req, res) => res.send('<h1>Bot is ALIVE!</h1>'));
          
          app.get('/qr', async (req, res) => {
            const url = await QRCode.toDataURL('TEST-QR-CODE');
            res.send(`<img src="${url}" />`);
          });
          
          app.listen(10000, () => console.log('Bot running on 10000'));
          EOF
          
          # Run in background
          node index.js &
          
      - name: ‚è≥ Keep Alive
        run: |
          echo "Testing URL: https://shikshaportal.netlify.app"
          echo "Testing QR: https://shikshaportal.netlify.app/qr"
          sleep 1800
