name: Debug Netlify (Fix Folder)

on: workflow_dispatch

jobs:
  debug-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Start Ngrok (Background)
      - name: ðŸš‡ Start Ngrok Tunnel
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}

          # Start tunnel on port 8080 (dummy port for test)
          ngrok http --domain=${{ secrets.NGROK_DOMAIN }} 8080 > ngrok.log &
          sleep 5

      # 2. Create Distribution Folder (CLEAN SETUP)
      - name: ðŸ“‚ Prepare Dist Folder
        run: |
          # Clean slate
          rm -rf dist
          mkdir dist

          # 1. Create Redirects inside dist
          # Redirect EVERYTHING to Ngrok
          echo "/* https://${{ secrets.NGROK_DOMAIN }}/:splat  200!" > dist/_redirects

          # 2. Create Index inside dist (Fallback)
          echo "<h1>Netlify is Working!</h1><p>If you see this, redirect failed.</p>" > dist/index.html

          # Verify
          echo "--- _redirects content ---"
          cat dist/_redirects

      # 3. Deploy ONLY the dist folder
      - name: ðŸš€ Deploy to Netlify
        run: |
          npm install -g netlify-cli
          # Important: We deploy the 'dist' folder explicitly
          netlify deploy --prod --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_TOKEN }} --dir=dist

      - name: âœ… Check Links
        run: |
          echo "Test Link: https://shikshaportal.netlify.app/webhook/test"
          echo "Expected: Ngrok Error Page (502 Bad Gateway)"
